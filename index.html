<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>找鱼之家</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="找鱼之家">
<meta property="og:url" content="http://jinzhaoyu.github.io/index.html">
<meta property="og:site_name" content="找鱼之家">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="找鱼之家">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="找鱼之家" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">找鱼之家</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Hey , I am zhaoyu ~</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://jinzhaoyu.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-android-multidex-noclassdeffound" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/17/android-multidex-noclassdeffound/" class="article-date">
  <time datetime="2015-11-17T12:27:39.000Z" itemprop="datePublished">2015-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/17/android-multidex-noclassdeffound/">Android - 支持multidex后NoClassDefFoundError的解决办法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="问题">问题</h2><p>Android应用支持multiDex以后，在某些5.0以下的机型上，会遇到某些类由于没有被打进MainDex中，而导致的 NoClassDefFoundError 错误。</p>
<p><strong><em>更多关于 ClassNotFoundException 和 NoClassDefFoundError 的讨论 <a href="http://stackoverflow.com/a/1457879/5571166" target="_blank" rel="external">可以到这里查看</a>.</em></strong></p>
<h2 id="解决方式">解决方式</h2><h3 id="过时的方式">过时的方式</h3><p>在使用Android gradle build tools 1.2.3 版本的时候，我们在 build.gradle 的 <code>defaultConfig</code> 中加入一个非公开属性 <code>multiDexKeepFile</code></p>
<blockquote>
<p>multiDexKeepFile file(“multidex.keep”)</p>
</blockquote>
<p>这个<code>multidex.keep</code>的内容，是要保持类在MainDex中的Class列表，如：</p>
<pre><code>com<span class="regexp">/alibaba/</span>mobileim<span class="regexp">/channel/</span>util/SimpleKVStore.<span class="keyword">class</span>
com<span class="regexp">/alibaba/</span>mobileim<span class="regexp">/channel/</span>util/SimpleKVStore$SingletonHolder.<span class="keyword">class</span>
android<span class="regexp">/webkit/</span>JniUtil.<span class="keyword">class</span>
mtopsdk<span class="regexp">/xstate/</span>XState.<span class="keyword">class</span>
android<span class="regexp">/app/</span>ANRManagerProxy.<span class="keyword">class</span>
</code></pre><h3 id="新的方式">新的方式</h3><p>但是随着升级 build tools 到 1.3.+ 的版本以后，这个功能就失效了。</p>
<h4 id="分析">分析</h4><p>查询了代码 1.2.3 和 1.3.1 的 build tools源码后，发现原来在 1.2.3版本 <a href="https://android.googlesource.com/platform/tools/base/+/gradle_1.2.3/build-system/gradle-core/src/main/groovy/com/android/build/gradle/internal/TaskManager.groovy" target="_blank" rel="external">TaskManager.groovy</a> 中 createPostCompilationTasks()方法里读取 <code>multiDexKeepFile</code>属性的代码都被干掉了。</p>
<blockquote>
<p>File multiDexKeepFile = config.getMultiDexKeepFile();</p>
</blockquote>
<p>1.3.0 及以后的版本中，优化了代码结构，设计了一些<a href="https://android.googlesource.com/platform/tools/base/+/gradle_1.3.1/build-system/gradle-core/src/main/groovy/com/android/build/gradle/internal/tasks/multidex/" target="_blank" rel="external">新的用于处理MultiDex的Task类</a>:</p>
<pre><code>CreateMainDexList<span class="class">.groovy</span>
CreateManifestKeepList<span class="class">.groovy</span>
JarMergingTask<span class="class">.groovy</span>
RetraceMainDexList.groovy
</code></pre><p>通过查看<a href="https://android.googlesource.com/platform/tools/base/+/gradle_1.3.1/build-system/gradle-core/src/main/groovy/com/android/build/gradle/internal/tasks/multidex/CreateMainDexList.groovy" target="_blank" rel="external">CreateMainDexList.groovy</a> 可以看出这个任务最终<br>会生成一个存储了所有应该在MainDex中的类列表的文件：<code>maindexlist.txt</code>。</p>
<p>生成的文件路径是从 <a href="https://android.googlesource.com/platform/tools/base/+/gradle_1.3.1/build-system/gradle-core/src/main/groovy/com/android/build/gradle/internal/scope/VariantScope.java" target="_blank" rel="external">VariantScope.java </a> 的<code>getMainDexListFile()</code>中获取的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@NonNull</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> File <span class="title">getMainDexListFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> File(globalScope.getIntermediatesDir(), <span class="string">"multi-dex/"</span> + </span><br><span class="line">       getVariantConfiguration().getDirName() + <span class="string">"/maindexlist.txt"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>最终生成的这个 <code>maindexlist.txt</code> 文件会被<a href="https://android.googlesource.com/platform/tools/base/+/gradle_1.3.1/build-system/builder/src/main/java/com/android/builder/core/DexProcessBuilder.java" target="_blank" rel="external">DexProcessBuilder.java</a>通过<code>--multi-dex --main-dex-list</code>参数传递给Build tools中的 <code>dx.jar</code>(在Android sdk跟目录下有个<code>build-tools</code>目录，你可以在这里找到这个jar)，<code>dx.jar</code>会用这个列表文件生成MainDex。</p>
<h4 id="解决思路">解决思路</h4><p>关键的来了，我们知道新的build tools是通过 <code>createMainDexList</code> 这个Task来生成的<code>maindexlist.txt</code>，然后才给 <code>dx.jar</code>去读取生成 MainDex，那么我们是不是可以hack一下构建过程，在 <code>createMainDexList</code> 执行完以后，我们去修改<code>maindexlist.txt</code>文件，以达到手工设置MainDex内容的目的呢？</p>
<h4 id="代码实现">代码实现</h4><p>结合gradle的构建过程，原来的<code>multidex.keep</code>文件位置和内容不变，最终实现代码如下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">afterEvaluate &#123;</span><br><span class="line">    tasks.matching&#123;</span><br><span class="line">        it.name.startsWith(<span class="string">'create'</span>) &amp;&amp; it.name.endsWith(<span class="string">'MainDexClassList'</span>)</span><br><span class="line">    &#125;.each &#123; tk -&gt;</span><br><span class="line">        tk.doLast &#123;</span><br><span class="line">            keepMainMultiDex(tk.outputFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 控制MainDex中的class列表</span><br><span class="line"> * 将multidex.keep的内容追加到 maindexlist.txt 中</span><br><span class="line"> * <span class="doctag">@param</span> outputFile</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">def</span> keepMainMultiDex(File outputFile)&#123;</span><br><span class="line">    File keepFile = file(<span class="string">"multidex.keep"</span>);</span><br><span class="line">    outputFile &lt;&lt; <span class="string">'\n'</span></span><br><span class="line">    outputFile &lt;&lt; keepFile.getText(<span class="string">'UTF-8'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>打完收工~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://jinzhaoyu.github.io/2015/11/17/android-multidex-noclassdeffound/" data-id="cih3cvk7w00015passj1o9qr9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-multidex-NoClassDefFoundError/">Android multidex NoClassDefFoundError</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android-hidden-foreground-service" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/17/android-hidden-foreground-service/" class="article-date">
  <time datetime="2015-11-17T12:27:10.000Z" itemprop="datePublished">2015-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/17/android-hidden-foreground-service/">Android - 琢磨隐藏前台服务的过程-隐藏的!</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在国内，Android平台下的应用因为种种原因，都必须要各自做各自的推送通道。然而，由于Android系统的特性，这些需要保持通道连接的应用，又要想方设法的防止被系统杀掉。（这时候真的觉得Apple的APNs 是一个神一样的存在！）</p>
<p>于是乎各种综合手段就都会用上了，比如分出一个守护进程，这个进程做的都是轻量的事情，甚至只检测主要进程的存活性。同时又在这个进程中启动一个前台服务（Foreground Service），尽可能减少这个守护进程被系统回收的机会。这里我就只说一下前台服务的事。</p>
<p>Android 系统的内存回收真正的执行者是 LowMemoryKiller(这里不做过多描述，可以参考： <a href="http://www.cnblogs.com/angeldevil/archive/2013/05/21/3090872.html" target="_blank" rel="external">http://www.cnblogs.com/angeldevil/archive/2013/05/21/3090872.html</a>) ，它将进程分了几个层次，其中最高层次的是：</p>
<pre><code><span class="comment">// This is the process running the current foreground app.  We'd really</span>
<span class="comment">// rather not kill it!</span>
<span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FOREGROUND_APP_ADJ = <span class="number">0</span>;
</code></pre><p>也就是说，前台进程是最后了，逼不得已的情况下才会去释放它占用的内存的。前台进程就是当前正在前台显示的，用户正在操作的界面，或者是一个前台的服务。</p>
<p>Android系统要求前台服务必须要发送一个Notification，以便告知用户有应用一直在运行中，让用户感知到这个应用可能会耗费他的电池或流量。但是有些时候，我们确实想隐藏这种Notification，还要保持在前台服务的运行，因为常驻通知栏的图标，有的用户需要，有的用户则强烈要求去掉。</p>
<p>我们发现，手机QQ有一个前台服务，可是状态栏和通知中心都看不到QQ的任何通知图标，用如下命令可以dump出来系统中正在运行的所有的Service ：</p>
<p><code>adb shell dumpsys activity services</code></p>
<p>可以看到手机QQ有三个Service：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">* ServiceRecord&#123;<span class="number">43</span>a6db20 u0 com.tencent.mobileqq/.app.CoreService&#125;</span><br><span class="line">intent=&#123;cmp=com.tencent.mobileqq/.app.CoreService&#125;</span><br><span class="line">packageName=com.tencent.mobileqq</span><br><span class="line">processName=com.tencent.mobileqq</span><br><span class="line">baseDir=/data/app/com.tencent.mobileqq-<span class="number">2.</span>apk</span><br><span class="line">dataDir=/data/data/com.tencent.mobileqq</span><br><span class="line">app=ProcessRecord&#123;<span class="number">435</span>c1a98 <span class="number">8126</span>:com.tencent.mobileqq/u0a10145&#125;</span><br><span class="line">createTime=-<span class="number">9</span>m52s660ms lastActivity=-<span class="number">4</span>m52s742ms</span><br><span class="line">executingStart=-<span class="number">4</span>m52s742ms restartTime=-<span class="number">9</span>m52s660ms</span><br><span class="line">startRequested=<span class="literal">true</span> stopIfKilled=<span class="literal">false</span> callStart=<span class="literal">true</span> lastStartId=<span class="number">7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* ServiceRecord&#123;<span class="number">4378</span>c818 u0 com.tencent.mobileqq/.app.CoreService$KernelService&#125;</span><br><span class="line">intent=&#123;cmp=com.tencent.mobileqq/.app.CoreService$KernelService&#125;</span><br><span class="line">packageName=com.tencent.mobileqq</span><br><span class="line">processName=com.tencent.mobileqq</span><br><span class="line">baseDir=/data/app/com.tencent.mobileqq-<span class="number">2.</span>apk</span><br><span class="line">dataDir=/data/data/com.tencent.mobileqq</span><br><span class="line">app=ProcessRecord&#123;<span class="number">435</span>c1a98 <span class="number">8126</span>:com.tencent.mobileqq/u0a10145&#125;</span><br><span class="line">isForeground=<span class="literal">true</span> foregroundId=<span class="number">537041609</span> foregroundNoti=Notification(pri=<span class="number">0</span> icon=<span class="number">7f</span>020314 contentView=com.tencent.mobileqq/<span class="number">0x10900b4</span> vibrate=null sound=null defaults=<span class="number">0x0</span> flags=<span class="number">0x62</span> when=<span class="number">1429702926311</span> ledARGB=<span class="number">0x0</span> contentIntent=Y deleteIntent=N contentTitle=QQ正在执行中 contentText=触控来取得更多信息，或停止应用程序 tickerText=N kind=[null])</span><br><span class="line">createTime=-<span class="number">9</span>m51s902ms lastActivity=-<span class="number">9</span>m51s902ms</span><br><span class="line">executingStart=-<span class="number">9</span>m51s897ms restartTime=-<span class="number">9</span>m51s902ms</span><br><span class="line">startRequested=<span class="literal">true</span> stopIfKilled=<span class="literal">true</span> callStart=<span class="literal">true</span> lastStartId=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* ServiceRecord&#123;<span class="number">43</span>a12670 u0 com.tencent.mobileqq/.msf.service.MsfService&#125;</span><br><span class="line">intent=&#123;cmp=com.tencent.mobileqq/.msf.service.MsfService&#125;</span><br><span class="line">packageName=com.tencent.mobileqq</span><br><span class="line">processName=com.tencent.mobileqq:MSF</span><br><span class="line">baseDir=/data/app/com.tencent.mobileqq-<span class="number">2.</span>apk</span><br><span class="line">dataDir=/data/data/com.tencent.mobileqq</span><br><span class="line">app=ProcessRecord&#123;<span class="number">432900e0</span> <span class="number">3974</span>:com.tencent.mobileqq:MSF/u0a10145&#125;</span><br><span class="line">createTime=-<span class="number">8</span>d3h5m17s705ms lastActivity=-<span class="number">9</span>m50s414ms</span><br><span class="line">……………………</span><br></pre></td></tr></table></figure>
<p>注意上面的标红的 .app.CoreService$KernelService ，其中有一个 isForeground=true 属性，其值为true，并且也设置了 foregroundNoti 的值，从这个Notification也看不出来有什么异常。<br>一开始以为他们用了什么手段搞了个看不见的通知，比如透明的图标或者高度为0的RemoteView，我也按这种思路去尝试了下，总有一个占位的Notification在。再 dump 出 Notification ：</p>
<p><code>adb shell dumpsys statusbar</code></p>
<p>查看 Notification list ，可以看到我做的透明的通知，却看不到有他们的任何 StatusBarNotification 那么它是怎么做到隐藏这个通知的呢？试试反编，看看他们的代码！</p>
<p>于是我就用 Android反编工具 试着反编手机QQ最新版 5.5.1.2435 ，直接就失败了，因为他们做了反apkTool的工作，无法用apkTool去解压他们的apk包。没关系，那我就直接解压缩QQ的安装包，毕竟apk也就是一种zip格式嘛。unzip解压后，可以看到目录中有一个 9.9M 的 classes.dex , 用 dex2jar 2.0 反编译它： </p>
<p><code>./decompileAndroid/dex2jar-2.0/d2j-dex2jar.sh -o source.jar classes.dex</code></p>
<p>竟然成功了！！用JD—GUI，打开这个source.jar文件，找到 CoreService 和其内部类 KernelService ： com.tencent.mobileqq.app.CoreService 、 com.tencent.mobileqq.app.CoreService$KernelService ,代码内容我就不贴出来了，有兴趣的同学可以自己动动手或者从附件中下载。这里我只说下我理解的大致过程：</p>
<p>1、 CoreService 是一个假的Service，应用启动时即开始启动这个Service，这个Service 会在 onCreate() 中就 startForeground() ，传的 Notification 是 new 出的一个空的通知，通知 ID 为固定的值。</p>
<p>2、 启动完 CoreService 就开始启动真正的 KernelService</p>
<p>3、 KernelService中将 CoreService 再次 startForeground() ，然后再把自己 startForeground() ，最后再把 CoreService stopForeground() 掉。这是非常关键的一步。同时，要确保两个 Service startForeground()时使用的 Notification ID 都是同一个！</p>
<p>最终，仿照手机QQ的实现代码为： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageCenterService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String sTAG = <span class="string">"MessageCenterService"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//9521 就是你的终身代号 :)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NOTIFY_ID = <span class="number">9521</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MessageCenterService instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MessageCenterService <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 启动前台服务</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(App.getContext(), MessageCenterService.class);</span><br><span class="line">            App.getContext().startService(intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.e(sTAG, <span class="string">""</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 终止前台服务。包含&#123;<span class="doctag">@link</span> MessageCenterService.KernelService&#125;</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(App.getContext(), MessageCenterService.class);</span><br><span class="line">            App.getContext().stopService(intent);</span><br><span class="line"></span><br><span class="line">            stopKernel();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.e(sTAG, <span class="string">""</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startKernel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(App.getContext(), KernelService.class);</span><br><span class="line">            App.getContext().startService(intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.e(sTAG, <span class="string">""</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">stopKernel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(App.getContext(), KernelService.class);</span><br><span class="line">            App.getContext().stopService(intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.e(sTAG, <span class="string">""</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        instance = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.JELLY_BEAN_MR2) &#123;</span><br><span class="line">            startForeground(NOTIFY_ID, <span class="keyword">new</span> Notification());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//启动真正的Service</span></span><br><span class="line">        startKernel();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.JELLY_BEAN_MR2) &#123;</span><br><span class="line">            stopForeground(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     *</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">KernelService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> KernelService instance;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> KernelService <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.onCreate();</span><br><span class="line">            instance = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MessageCenterService fakeService = MessageCenterService.getInstance();</span><br><span class="line">                fakeService.startForeground(NOTIFY_ID, <span class="keyword">new</span> Notification());</span><br><span class="line">                startForeground(NOTIFY_ID, <span class="keyword">new</span> Notification());</span><br><span class="line">                fakeService.stopForeground(<span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LogUtil.e(sTAG, <span class="string">" **** Can not start foreground service !! ****"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> START_STICKY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            stopForeground(<span class="keyword">true</span>);</span><br><span class="line">            instance = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里面有一些自己的工具类什么的，大家可以替换为自己的东西，同时别忘了在 AndroidManifest.xml中定义下这两个Service：</p>
<pre><code class="xml"><span class="tag">&lt;<span class="title">service</span>
     <span class="attribute">android:name</span>=<span class="value">".service.MessageCenterService$KernelService"</span>
     <span class="attribute">android:label</span>=<span class="value">"@string/message_center_service"</span>
     <span class="attribute">android:exported</span>=<span class="value">"false"</span>/&gt;</span>
<span class="tag">&lt;<span class="title">service</span>
     <span class="attribute">android:name</span>=<span class="value">".service.MessageCenterService"</span>
     <span class="attribute">android:label</span>=<span class="value">"@string/message_center_service"</span>
     <span class="attribute">android:exported</span>=<span class="value">"false"</span>/&gt;</span>
</code></pre>
<p>今天又去stackOverflow上有针对性的查了下这个方法，还真有人说过这种处理方式：</p>
<p><a href="http://stackoverflow.com/a/18281520" target="_blank" rel="external">http://stackoverflow.com/a/18281520</a></p>
<p>以上就可以实现一个隐藏的前台服务，增加应用的存活率。看下LowMemoryKiller的分析后，你就应该知道，无论是那种级别的进程，都会有一个内存占用的阈值的，超过这个阈值同样会被杀，所以，优化好应用的内存使用也同样重要。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://jinzhaoyu.github.io/2015/11/17/android-hidden-foreground-service/" data-id="cih3cvk8500045pasvl0ygos5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-前台服务-隐藏/">Android 前台服务 隐藏</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android-AppCompat-v7-options-menu" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/17/android-AppCompat-v7-options-menu/" class="article-date">
  <time datetime="2015-11-17T12:25:23.000Z" itemprop="datePublished">2015-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/17/android-AppCompat-v7-options-menu/">Android - AppCompat-v7包踩坑记：活动菜单</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#坑<br>最近为了使用Android 5.0里的一些UI特性，又懒得写一堆不同系统版本的styles文件。就引入了<a href="https://developer.android.com/intl/zh-cn/tools/support-library/features.html" target="_blank" rel="external">AppCompat-v7 Support Library</a> ，使用了 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html" target="_blank" rel="external">AppCompatActivity</a> ,可是在测试期间就发现了兼容性问题: 小米手机 和 三星S6 无法打开活动菜单(OptionsMenu)。</p>
<p>多扯一点，对于OptionsMenu，<a href="http://developer.android.com/intl/zh-cn/guide/topics/ui/menus.html" target="_blank" rel="external">官方文档 </a> 中说：</p>
<blockquote>
<p>Beginning with Android 3.0, the Menu button is deprecated (some devices don’t have one), so you should migrate toward using the action bar to provide access to actions and other options.</p>
</blockquote>
<p>千牛Android没有使用 ActionBar 或 ToolBar，因此只能弹出老式的活动菜单。不过活动菜单中的功能在千牛的界面中都是有入口的，活动菜单只是作为一个便捷的入口而提供的。</p>
<p>上面说到了小米手机和三星S6的问题，他们都有一个共同的特点，就是没有Menu键。Menu键都是通过长按某个按键模拟的：小米的菜单按键在新的MIUI中，单击是显示最近任务，长按才是菜单键。而三星S6是长按返回键模拟菜单键。</p>
<p>#分析<br>为了兼容各个版本的系统，AppCompatActivity中实际是使用了一个 <a href="http://developer.android.com/reference/android/support/v7/app/AppCompatDelegate.html" target="_blank" rel="external">AppCompatDelegate</a> 来处理Activity的各个生命周期及事件回调。这个抽象类目前有这几个包访问级别的子类: <code>AppCompatDelegateImplV7</code> 、 <code>AppCompatDelegateImplV11</code> 、 <code>AppCompatDelegateImplV14</code>，他们负责对具体的系统版本做具体的处理，他们之间也存在继承关系。</p>
<p>##小米<br>通过追踪<code>dispatchKeyEvent()</code> 方法，一路下来，追到了 <code>AppCompatDelegateImplV7.onKeyDownPanel()</code> 方法，其代码如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> boolean <span class="title">onKeyDownPanel</span>(<span class="params"><span class="keyword">int</span> featureId, KeyEvent <span class="keyword">event</span></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">event</span>.getRepeatCount() == <span class="number">0</span>) &#123;</span><br><span class="line">           PanelFeatureState st = getPanelState(featureId, <span class="keyword">true</span>);</span><br><span class="line">           <span class="keyword">if</span> (!st.isOpen) &#123;</span><br><span class="line">               <span class="keyword">return</span> preparePanel(st, <span class="keyword">event</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>if (event.getRepeatCount() == 0)</code> 决定了是否显示菜单的Panel。</p>
<p>某个键被长按时，这个键的 getRepeatCount 是会从0开始往上递增的，由于MIUI是在长按设备上的菜单键时才会把菜单键的点击事件交给App，单击菜单键就被系统拦截，显示最近任务。</p>
<p>当Activity收到Key code 为 82 的菜单键事件时，这个<code>KeyEvent.getRepeatCount()</code>取到的是已经不是0了，因为长按会把它累加成一个大于0的数字。</p>
<p>正是由于<code>KeyEvent.getRepeatCount()</code>大于0，才因为<code>AppCompatDelegateImplV7.onKeyDownPanel()</code>方法里的判断，菜单弹出事件而被过滤掉。</p>
<p>知道原因了，那我们就想办法把 <code>dispatchKeyEvent()</code> 获取到的KeyEvent中的<code>getRepeatCount()</code>值改成 0 就好了。</p>
<p>##三星S6<br>三星S6是通过长按返回键（Key code = 4）来模拟的菜单键（Key code = 82），在这款手机上的表现是，显示了菜单但是马上又被关闭了。<br>通过增加日志：</p>
<table>
<thead>
<tr>
<th>event.getAction(): 0</th>
<th>event.getKeyCode(): 4</th>
<th>event.getRepeatCount(): 0</th>
</tr>
</thead>
<tbody>
<tr>
<td>…</td>
</tr>
<tr>
<td>event.getAction(): 0</td>
<td>event.getKeyCode(): 4</td>
<td>event.getRepeatCount(): 10</td>
</tr>
<tr>
<td>event.getAction(): 0</td>
<td>event.getKeyCode(): 82</td>
<td>event.getRepeatCount(): 0</td>
</tr>
<tr>
<td>event.getAction(): 1</td>
<td>event.getKeyCode(): 82</td>
<td>event.getRepeatCount(): 0</td>
</tr>
<tr>
<td>event.getAction(): 0</td>
<td>event.getKeyCode(): 4</td>
<td>event.getRepeatCount(): 0</td>
</tr>
</tbody>
</table>
<p><em>eventAction = 1 表示 KeyUp ， 0 表示 KeyDown</em></p>
<p>可以看出在长按返回键的过程中会发出模拟的菜单键的KeyDown 和 KeyUp事件，但是返回键的KeyUp在菜单键的事件完成后才执行。这就要了命了，我菜单刚显示出来，你一个返回键的KeyUp事件把我的菜单就又给关闭了。</p>
<p>#填坑代码<br>综上分析，解决办法如下：</p>
<h2 id="AppCompatActivity_的子类">AppCompatActivity 的子类</h2><p>在 AppCompatActivity 子类的 <code>onCreate()</code> 方法中指定自定义的 WindowCallback ,代理掉 <code>dispatchKeyEvent()</code> ，利用装饰者模式，处理键盘事件，又不影响AppCompatActivity中原来的逻辑：</p>
<figure class="highlight sml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(getWindow<span class="literal">()</span>.getCallback<span class="literal">()</span> != null) &#123;</span><br><span class="line">	getWindow<span class="literal">()</span>.setCallback(new <span class="type">AppCompatWindowCallbackWrapper</span>(getWindow<span class="literal">()</span>.getCallback<span class="literal">()</span>));</span><br><span class="line">&#125;</span><br><span class="line">```        </span><br><span class="line"></span><br><span class="line">## 实现 <span class="type">WindowCallbackWrapper</span> </span><br><span class="line">以下代码中有注释，就不多说了</span><br></pre></td></tr></table></figure>
<p>package com.taobao.qianniu.common.widget;</p>
<p>import android.support.v7.internal.view.WindowCallbackWrapper;<br>import android.view.KeyEvent;<br>import android.view.Window;</p>
<p>import com.taobao.qianniu.common.utils.PhoneInfo;<br>import com.taobao.qianniu.component.utils.LogUtil;<br>import com.taobao.qianniu.controller.common.debugmode.DebugController;<br>import com.taobao.qianniu.controller.common.debugmode.DebugKey;</p>
<p>/**</p>
<ul>
<li>为了解决Support V7包的 AppCompatActivity 中对菜单事件的兼容问题,</li>
<li>如小米手机和三星S6 通过长按某个按键模拟菜单键的问题<br>*</li>
<li><p>@author jinzhaoyu<br>*/<br>public class AppCompatWindowCallbackWrapper extends WindowCallbackWrapper {<br> private static final String sTAG = “AppCompatWindowCallbackWrapper”;</p>
<p> public AppCompatWindowCallbackWrapper(Window.Callback wrapped) {</p>
<pre><code>super<span class="list">(<span class="keyword">wrapped</span>)</span><span class="comment">;</span>
</code></pre><p> }</p>
<p> @Override<br> public boolean dispatchKeyEvent(KeyEvent event) {</p>
<pre><code>KeyEvent newEvent = <span class="keyword">event</span>;
<span class="keyword">if</span>(DebugController.isEnable(DebugKey.LOG_DEBUG)) {
    LogUtil.d(sTAG, <span class="string">"KeyEvent.getAction:"</span> + <span class="keyword">event</span>.getAction() + <span class="string">"    getKeyCode:"</span> + <span class="keyword">event</span>.getKeyCode() + <span class="string">"    getRepeatCount:"</span> + <span class="keyword">event</span>.getRepeatCount());
}
<span class="keyword">if</span> (PhoneInfo.isXiaoMiMobile()) {
    <span class="comment">//解决小米手机，长按菜单键才能调出菜单的问题</span>
    <span class="keyword">if</span> (<span class="keyword">event</span>.getAction() == KeyEvent.ACTION_DOWN
            &amp;&amp; <span class="keyword">event</span>.getKeyCode() == KeyEvent.KEYCODE_MENU
            &amp;&amp; <span class="keyword">event</span>.getRepeatCount() &gt; <span class="number">0</span>) {
        <span class="comment">//需要将event.mRepeatCount设置为0，才能绕过 AppCompatDelegateImplV7#onKeyDownPanel</span>
        <span class="comment">//方法中对repeatCount的条件判断，进而弹出菜单。</span>
        newEvent = KeyEvent.changeTimeRepeat(<span class="keyword">event</span>, <span class="keyword">event</span>.getEventTime(), <span class="number">0</span>);
    }
} <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">PhoneInfo.isSamsungMobile(</span>)) </span>{
    <span class="comment">//解决三星S6，长按返回键调出菜单的问题</span>
    <span class="keyword">if</span> (checkSamsungKeyEvent(<span class="keyword">event</span>)){
        <span class="keyword">return</span> <span class="keyword">true</span>;
    }
}
<span class="keyword">return</span> super.dispatchKeyEvent(newEvent);
</code></pre><p> }</p>
</li>
</ul>
<pre><code><span class="keyword">private</span> <span class="keyword">boolean</span> isSamsungBackLongPressed = <span class="keyword">false</span>;
<span class="keyword">private</span> <span class="keyword">boolean</span> isSamsungMockMenuKey = <span class="keyword">false</span>;
<span class="comment">/**
 * 兼容三星手机用长按返回模拟菜单键的问题
 * <span class="doctag">@param</span> keyEvent
 * <span class="doctag">@return</span>
 */</span>
<span class="keyword">private</span> <span class="function"><span class="keyword">boolean</span> <span class="title">checkSamsungKeyEvent</span><span class="params">(KeyEvent keyEvent)</span></span>{
    <span class="keyword">switch</span> (keyEvent.getAction()){
        <span class="keyword">case</span> KeyEvent.ACTION_DOWN:
            //三星S6 通过长按返回键模拟菜单键
            <span class="keyword">if</span>(keyEvent.getKeyCode() == KeyEvent.KEYCODE_BACK &amp;&amp; keyEvent.getRepeatCount() &gt; 0){
                isSamsungBackLongPressed = <span class="keyword">true</span>;
            }
            <span class="comment">//如果在长按返回没有结束时，收到了菜单键的KeyDown，那么就是Mock的菜单</span>
            <span class="keyword">if</span>(isSamsungBackLongPressed &amp;&amp; keyEvent.getKeyCode() == KeyEvent.KEYCODE_MENU){
                isSamsungMockMenuKey = <span class="keyword">true</span>;
            }
            <span class="keyword">break</span>;
        <span class="keyword">case</span> KeyEvent.ACTION_UP:
            <span class="keyword">if</span>(keyEvent.getKeyCode() == KeyEvent.KEYCODE_BACK){
                isSamsungBackLongPressed = <span class="keyword">false</span>;
                <span class="keyword">if</span>(isSamsungMockMenuKey){
                    isSamsungMockMenuKey = <span class="keyword">false</span>;
                    <span class="keyword">return</span> <span class="keyword">true</span>;
                }
            }
            <span class="keyword">break</span>;

    }
    <span class="keyword">return</span> <span class="keyword">false</span>;
}
</code></pre><p>}<br>```</p>
<p>可能还有其他机型有类似的问题，也只能碰到一例解决一例了。或者让这逆潮流的功能慢慢消失也不一定是件坏事。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://jinzhaoyu.github.io/2015/11/17/android-AppCompat-v7-options-menu/" data-id="cih3cvk8800075pasqppyluw5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-AppCompat-菜单/">Android AppCompat 菜单</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-AppCompat-菜单/">Android AppCompat 菜单</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-multidex-NoClassDefFoundError/">Android multidex NoClassDefFoundError</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-前台服务-隐藏/">Android 前台服务 隐藏</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android-AppCompat-菜单/" style="font-size: 10px;">Android AppCompat 菜单</a> <a href="/tags/Android-multidex-NoClassDefFoundError/" style="font-size: 10px;">Android multidex NoClassDefFoundError</a> <a href="/tags/Android-前台服务-隐藏/" style="font-size: 10px;">Android 前台服务 隐藏</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/11/17/android-multidex-noclassdeffound/">Android - 支持multidex后NoClassDefFoundError的解决办法</a>
          </li>
        
          <li>
            <a href="/2015/11/17/android-hidden-foreground-service/">Android - 琢磨隐藏前台服务的过程-隐藏的!</a>
          </li>
        
          <li>
            <a href="/2015/11/17/android-AppCompat-v7-options-menu/">Android - AppCompat-v7包踩坑记：活动菜单</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 jinzhaoyu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>